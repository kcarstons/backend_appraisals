import boto3
from io import BytesIO
import pypdfium2 as pdfium 
#from IPython.display import display, HTML
import os
import re
from transformers import AutoTokenizer, pipeline


def read_from_s3(file_name):
    """
    Read one file in at a time
    """
    s3 = boto3.client("s3")
    bucket = 'a1156-val'
    data_key = f"backend_appraisals/sample_data/{file_name}.pdf"
    data_location = 's3://{}/{}'.format(bucket, data_key) 

    pdf_file = s3.get_object(Bucket = bucket, Key = data_key)[
        "Body"
    ].read()

    return pdf_file



def extract_all_text(file_name): 
    """
    Extracts all text from a pdf"
    """
    
    text_pages = [] 
    pdf = pdfium.PdfDocument(BytesIO(read_from_s3(file_name)))

    for i in range(len(pdf)):
        page = pdf[i]
        text = page.get_textpage().get_text_range()
        text_pages.append(text) 

    return text_pages




extracted_text = str(extract_all_text('appraisal_sf'))

# remove escape characters and new lines
cleaned_text = re.sub(r'\\n', ' ', extracted_text) 

# remove non-ASCII characters
cleaned_text = re.sub(r'[^\x00-\x7F]+', ' ', cleaned_text)

#remove backslashes
cleaned_text = re.sub(r'\\', ' ', cleaned_text)

#remove multiple spaces
cleaned_text = re.sub(r'\s+', ' ', cleaned_text)

#remove multiple spaces with single space
cleaned_text = cleaned_text.strip() 

quality_and_condition = 'UNIFORM APPRAISAL DATASET (UAD) DEFINITIONS ADDENDUM r (Source: Fannie Mae UAD Appendix D: UAD Field-Specific Standardization Requirements) r Condition Ratings and Definitions r C1 r The improvements have been very recently constructed and have not previously been occupied. The entire structure and all components are new r and the dwelling features no physical depreciation.* r *Note: Newly constructed improvements that feature recycled materials and/or components can be considered new dwellings provided that the r dwelling is placed on a 100% new foundation and the recycled materials and the recycled components have been rehabilitated/re-manufactured r into like-new condition. Recently constructed improvements that have not been previously occupied are not considered new if they have any r significant physical depreciation (i.e., newly constructed dwellings that have been vacant for an extended period of time without adequate r maintenance or upkeep). r C2 r The improvements feature no deferred maintenance, little or no physical depreciation, and require no repairs. Virtually all building components r are new or have been recently repaired, refinished, or rehabilitated. All outdated components and finishes have been updated and/or replaced r with components that meet current standards. Dwellings in this category either are almost new or have been recently completely renovated and r are similar in condition to new construction. r C3 r The improvements are well maintained and feature limited physical depreciation due to normal wear and tear. Some components, but not every r major building component, may be updated or recently rehabilitated. The structure has been well maintained. r C4 r The improvements feature some minor deferred maintenance and physical deterioration due to normal wear and tear. The dwelling has been r adequately maintained and requires only minimal repairs to building components/mechanical systems and cosmetic repairs. All major building r components have been adequately maintained and are functionally adequate. r C5 r The improvements feature obvious deferred maintenance and are in need of some significant repairs. Some building components need repairs, r rehabilitation, or updating. The functional utility and overall livability is somewhat diminished due to condition, but the dwelling remains r useable and functional as a residence. r C6 r The improvements have substantial damage or deferred maintenance with deficiencies or defects that are severe enough to affect the safety, r soundness, or structural integrity of the improvements. The improvements are in need of substantial repairs and rehabilitation, including many r or most major components. r Quality Ratings and Definitions r Q1 r Dwellings with this quality rating are usually unique structures that are individually designed by an architect for a specified user. Such r residences typically are constructed from detailed architectural plans and specifications and feature an exceptionally high level of workmanship r and exceptionally high-grade materials throughout the interior and exterior of the structure. The design features exceptionally high-quality r exterior refinements and ornamentation, and exceptionally high-quality interior refinements. The workmanship, materials, and finishes r throughout the dwelling are of exceptionally high quality. r Q2 r Dwellings with this quality rating are often custom designed for construction on an individual property owner s site. However, dwellings in r this quality grade are also found in high-quality tract developments featuring residence constructed from individual plans or from highly r modified or upgraded plans. The design features detailed, high quality exterior ornamentation, high-quality interior refinements, and detail. The r workmanship, materials, and finishes throughout the dwelling are generally of high or very high quality. r Q3 r Dwellings with this quality rating are residences of higher quality built from individual or readily available designer plans in above-standard r residential tract developments or on an individual property owner s site. The design includes significant exterior ornamentation and interiors r that are well finished. The workmanship exceeds acceptable standards and many materials and finishes throughout the dwelling have been r upgraded from stock standards. r Q4 r Dwellings with this quality rating meet or exceed the requirements of applicable building codes. Standard or modified standard building plans r are utilized and the design includes adequate fenestration and some exterior ornamentation and interior refinements. Materials, workmanship, r finish, and equipment are of stock or builder grade and may feature some upgrades. r UAD Version 9/2011\', \'Form UADDEFINE - "TOTAL" appraisal software by a la mode, inc. - 1-800-ALAMODE r UNIFORM APPRAISAL DATASET (UAD) DEFINITIONS ADDENDUM r (Source: Fannie Mae UAD Appendix D: UAD Field-Specific Standardization Requirements) r Quality Ratings and Definitions (continued) r Q5 r Dwellings with this quality rating feature economy of construction and basic functionality as main considerations. Such dwellings feature a r plain design using readily available or basic floor plans featuring minimal fenestration and basic finishes with minimal exterior ornamentation r and limited interior detail. These dwellings meet minimum building codes and are constructed with inexpensive, stock materials r with limited refinements and upgrades. r Q6 r Dwellings with this quality rating are of basic quality and lower cost; some may not be suitable for year-round occupancy. Such dwellings r are often built with simple plans or without plans, often utilizing the lowest quality building materials. Such dwellings are often built or r expanded by persons who are professionally unskilled or possess only minimal construction skills. Electrical, plumbing, and other mechanical r systems and equipment may be minimal or non-existent. Older dwellings may feature one or more substandard or non-conforming additions r to the original structure r Definitions of Not Updated, Updated, and Remodeled r Not Updated r Little or no updating or modernization. This description includes, but is not limited to, new homes. r Residential properties of fifteen years of age or less often reflect an original condition with no updating, if no major r components have been replaced or updated. Those over fifteen years of age are also considered not updated if the r appliances, fixtures, and finishes are predominantly dated. An area that is Not Updated may still be well maintained r and fully functional, and this rating does not necessarily imply deferred maintenance or physical/functional deterioration. r Updated r The area of the home has been modified to meet current market expectations. These modifications r are limited in terms of both scope and cost. r An updated area of the home should have an improved look and feel, or functional utility. Changes that constitute r updates include refurbishment and/or replacing components to meet existing market expectations. Updates do not r include significant alterations to the existing structure. r Remodeled r Significant finish and/or structural changes have been made that increase utility and appeal through r complete replacement and/or expansion. r A remodeled area reflects fundamental changes that include multiple alterations. These alterations may include r some or all of the following: replacement of a major component (cabinet(s), bathtub, or bathroom tile), relocation r of plumbing/gas fixtures/appliances, significant structural alterations (relocating walls, and/or the addition of) r square footage). This would include a complete gutting and rebuild. r Explanation of Bathroom Count r Three-quarter baths are counted as a full bath in all cases. Quarter baths (baths that feature only a toilet) are not r included in the bathroom count. The number of full and half baths is reported by separating the two values using a r period, where the full bath count is represented to the left of the period and the half bath count is represented to the r right of the period. r Example: r 3.2 indicates three full baths and two half baths.'
appendix = 'UNIFORM APPRAISAL DATASET (UAD) DEFINITIONS ADDENDUM r (Source: Fannie Mae UAD Appendix D: UAD Field-Specific Standardization Requirements) r Abbreviations Used in Data Standardization Text r Abbreviation Full Name Fields Where This Abbreviation May Appear r ac Acres Area, Site r AdjPrk Adjacent to Park Location r AdjPwr Adjacent to Power Lines Location r A Adverse Location & View r ArmLth Arms Length Sale Sale or Financing Concessions r ba Bathroom(s) Basement & Finished Rooms Below Grade r br Bedroom Basement & Finished Rooms Below Grade r B Beneficial Location & View r Cash Cash Sale or Financing Concessions r CtySky City View Skyline View View r CtyStr City Street View View r Comm Commercial Influence Location r c Contracted Date Date of Sale/Time r Conv Conventional Sale or Financing Concessions r CrtOrd Court Ordered Sale Sale or Financing Concessions r DOM Days On Market Data Sources r e Expiration Date Date of Sale/Time r Estate Estate Sale Sale or Financing Concessions r FHA Federal Housing Authority Sale or Financing Concessions r GlfCse Golf Course Location r Glfvw Golf Course View View r Ind Industrial Location & View r in Interior Only Stairs Basement & Finished Rooms Below Grade r Lndfl Landfill Location r LtdSght Limited Sight View r Listing Listing Sale or Financing Concessions r Mtn Mountain View View r N Neutral Location & View r NonArm Non-Arms Length Sale Sale or Financing Concessions r BsyRd Busy Road Location r o Other Basement & Finished Rooms Below Grade r Prk Park View View r Pstrl Pastoral View View r PwrLn Power Lines View r PubTrn Public Transportation Location r rr Recreational (Rec) Room Basement & Finished Rooms Below Grade r Relo Relocation Sale Sale or Financing Concessions r REO REO Sale Sale or Financing Concessions r Res Residential Location & View r RH USDA - Rural Housing Sale or Financing Concessions r s Settlement Date Date of Sale/Time r Short Short Sale Sale or Financing Concessions r sf Square Feet Area, Site, Basement r sqm Square Meters Area, Site r Unk Unknown Date of Sale/Time r VA Veterans Administration Sale or Financing Concessions r w Withdrawn Date Date of Sale/Time r wo Walk Out Basement Basement & Finished Rooms Below Grade r wu Walk Up Basement Basement & Finished Rooms Below Grade r WtrFr Water Frontage Location r Wtr Water View View r Woods Woods View View r Other Appraiser-Defined Abbreviations r Abbreviation Full Name Fields Where This Abbreviation May Appear'
#remove = 'UNIFORM APPRAISAL DATASET (UAD) DEFINITIONS ADDENDUM r (Source: Fannie Mae UAD Appendix D: UAD Field-Specific Standardization Requirements) r Condition Ratings and Definitions r C1 r The improvements have been very recently constructed and have not previously been occupied. The entire structure and all components are new r and the dwelling features no physical depreciation.* r *Note: Newly constructed improvements that feature recycled materials and/or components can be considered new dwellings provided that the r dwelling is placed on a 100% new foundation and the recycled materials and the recycled components have been rehabilitated/re-manufactured r into like-new condition. Recently constructed improvements that have not been previously occupied are not considered new if they have any r significant physical depreciation (i.e., newly constructed dwellings that have been vacant for an extended period of time without adequate r maintenance or upkeep). r C2 r The improvements feature no deferred maintenance, little or no physical depreciation, and require no repairs. Virtually all building components r are new or have been recently repaired, refinished, or rehabilitated. All outdated components and finishes have been updated and/or replaced r with components that meet current standards. Dwellings in this category either are almost new or have been recently completely renovated and r are similar in condition to new construction. r C3 r The improvements are well maintained and feature limited physical depreciation due to normal wear and tear. Some components, but not every r major building component, may be updated or recently rehabilitated. The structure has been well maintained. r C4 r The improvements feature some minor deferred maintenance and physical deterioration due to normal wear and tear. The dwelling has been r adequately maintained and requires only minimal repairs to building components/mechanical systems and cosmetic repairs. All major building r components have been adequately maintained and are functionally adequate. r C5 r The improvements feature obvious deferred maintenance and are in need of some significant repairs. Some building components need repairs, r rehabilitation, or updating. The functional utility and overall livability is somewhat diminished due to condition, but the dwelling remains r useable and functional as a residence. r C6 r The improvements have substantial damage or deferred maintenance with deficiencies or defects that are severe enough to affect the safety, r soundness, or structural integrity of the improvements. The improvements are in need of substantial repairs and rehabilitation, including many r or most major components. r Quality Ratings and Definitions r Q1 r Dwellings with this quality rating are usually unique structures that are individually designed by an architect for a specified user. Such r residences typically are constructed from detailed architectural plans and specifications and feature an exceptionally high level of workmanship r and exceptionally high-grade materials throughout the interior and exterior of the structure. The design features exceptionally high-quality r exterior refinements and ornamentation, and exceptionally high-quality interior refinements. The workmanship, materials, and finishes r throughout the dwelling are of exceptionally high quality. r Q2 r Dwellings with this quality rating are often custom designed for construction on an individual property owner s site. However, dwellings in r this quality grade are also found in high-quality tract developments featuring residence constructed from individual plans or from highly r modified or upgraded plans. The design features detailed, high quality exterior ornamentation, high-quality interior refinements, and detail. The r workmanship, materials, and finishes throughout the dwelling are generally of high or very high quality. r Q3 r Dwellings with this quality rating are residences of higher quality built from individual or readily available designer plans in above-standard r residential tract developments or on an individual property owner s site. The design includes significant exterior ornamentation and interiors r that are well finished. The workmanship exceeds acceptable standards and many materials and finishes throughout the dwelling have been r upgraded from stock standards. r Q4 r Dwellings with this quality rating meet or exceed the requirements of applicable building codes. Standard or modified standard building plans r are utilized and the design includes adequate fenestration and some exterior ornamentation and interior refinements. Materials, workmanship, r finish, and equipment are of stock or builder grade and may feature some upgrades. r UAD Version 9/2011\', \'Form UADDEFINE - "TOTAL" appraisal software by a la mode, inc. - 1-800-ALAMODE r UNIFORM APPRAISAL DATASET (UAD) DEFINITIONS ADDENDUM r (Source: Fannie Mae UAD Appendix D: UAD Field-Specific Standardization Requirements) r Quality Ratings and Definitions (continued) r Q5 r Dwellings with this quality rating feature economy of construction and basic functionality as main considerations. Such dwellings feature a r plain design using readily available or basic floor plans featuring minimal fenestration and basic finishes with minimal exterior ornamentation r and limited interior detail. These dwellings meet minimum building codes and are constructed with inexpensive, stock materials r with limited refinements and upgrades. r Q6 r Dwellings with this quality rating are of basic quality and lower cost; some may not be suitable for year-round occupancy. Such dwellings r are often built with simple plans or without plans, often utilizing the lowest quality building materials. Such dwellings are often built or r expanded by persons who are professionally unskilled or possess only minimal construction skills. Electrical, plumbing, and other mechanical r systems and equipment may be minimal or non-existent. Older dwellings may feature one or more substandard or non-conforming additions r to the original structure r Definitions of Not Updated, Updated, and Remodeled r Not Updated r Little or no updating or modernization. This description includes, but is not limited to, new homes. r Residential properties of fifteen years of age or less often reflect an original condition with no updating, if no major r components have been replaced or updated. Those over fifteen years of age are also considered not updated if the r appliances, fixtures, and finishes are predominantly dated. An area that is Not Updated may still be well maintained r and fully functional, and this rating does not necessarily imply deferred maintenance or physical/functional deterioration. r Updated r The area of the home has been modified to meet current market expectations. These modifications r are limited in terms of both scope and cost. r An updated area of the home should have an improved look and feel, or functional utility. Changes that constitute r updates include refurbishment and/or replacing components to meet existing market expectations. Updates do not r include significant alterations to the existing structure. r Remodeled r Significant finish and/or structural changes have been made that increase utility and appeal through r complete replacement and/or expansion. r A remodeled area reflects fundamental changes that include multiple alterations. These alterations may include r some or all of the following: replacement of a major component (cabinet(s), bathtub, or bathroom tile), relocation r of plumbing/gas fixtures/appliances, significant structural alterations (relocating walls, and/or the addition of) r square footage). This would include a complete gutting and rebuild. r Explanation of Bathroom Count r Three-quarter baths are counted as a full bath in all cases. Quarter baths (baths that feature only a toilet) are not r included in the bathroom count. The number of full and half baths is reported by separating the two values using a r period, where the full bath count is represented to the left of the period and the half bath count is represented to the r right of the period. r Example: r 3.2 indicates three full baths and two half baths. r UAD Version 9/2011\', \'Form UADDEFINE - "TOTAL" appraisal software by a la mode, inc. - 1-800-ALAMODE r UNIFORM APPRAISAL DATASET (UAD) DEFINITIONS ADDENDUM r (Source: Fannie Mae UAD Appendix D: UAD Field-Specific Standardization Requirements) r Abbreviations Used in Data Standardization Text r Abbreviation Full Name Fields Where This Abbreviation May Appear r ac Acres Area, Site r AdjPrk Adjacent to Park Location r AdjPwr Adjacent to Power Lines Location r A Adverse Location & View r ArmLth Arms Length Sale Sale or Financing Concessions r ba Bathroom(s) Basement & Finished Rooms Below Grade r br Bedroom Basement & Finished Rooms Below Grade r B Beneficial Location & View r Cash Cash Sale or Financing Concessions r CtySky City View Skyline View View r CtyStr City Street View View r Comm Commercial Influence Location r c Contracted Date Date of Sale/Time r Conv Conventional Sale or Financing Concessions r CrtOrd Court Ordered Sale Sale or Financing Concessions r DOM Days On Market Data Sources r e Expiration Date Date of Sale/Time r Estate Estate Sale Sale or Financing Concessions r FHA Federal Housing Authority Sale or Financing Concessions r GlfCse Golf Course Location r Glfvw Golf Course View View r Ind Industrial Location & View r in Interior Only Stairs Basement & Finished Rooms Below Grade r Lndfl Landfill Location r LtdSght Limited Sight View r Listing Listing Sale or Financing Concessions r Mtn Mountain View View r N Neutral Location & View r NonArm Non-Arms Length Sale Sale or Financing Concessions r BsyRd Busy Road Location r o Other Basement & Finished Rooms Below Grade r Prk Park View View r Pstrl Pastoral View View r PwrLn Power Lines View r PubTrn Public Transportation Location r rr Recreational (Rec) Room Basement & Finished Rooms Below Grade r Relo Relocation Sale Sale or Financing Concessions r REO REO Sale Sale or Financing Concessions r Res Residential Location & View r RH USDA - Rural Housing Sale or Financing Concessions r s Settlement Date Date of Sale/Time r Short Short Sale Sale or Financing Concessions r sf Square Feet Area, Site, Basement r sqm Square Meters Area, Site r Unk Unknown Date of Sale/Time r VA Veterans Administration Sale or Financing Concessions r w Withdrawn Date Date of Sale/Time r wo Walk Out Basement Basement & Finished Rooms Below Grade r wu Walk Up Basement Basement & Finished Rooms Below Grade r WtrFr Water Frontage Location r Wtr Water View View r Woods Woods View View r Other Appraiser-Defined Abbreviations r Abbreviation Full Name Fields Where This Abbreviation May Appear r UAD Version 9/2011\'

cleaned_text = cleaned_text.replace(quality_and_condition, '')
cleaned_text = cleaned_text.replace(appendix, '')


bert_pipeline = pipeline("sentiment-analysis", model = "nlptown/bert-base-multilingual-uncased-sentiment", truncation = True)
bert_results = bert_pipeline(cleaned_text)
print(bert_results)
#[{'label': '1 star', 'score': 0.3180265426635742}]  (very negative)


#must manually tokenize and truncate
tokenizer = AutoTokenizer.from_pretrained("cardiffnlp/twitter-roberta-base-sentiment-latest")
tokens = tokenizer(cleaned_text, truncation = True, padding = True, max_length = 512, return_tensors = "pt")

roberta_pipeline = pipeline("sentiment-analysis", model = "cardiffnlp/twitter-roberta-base-sentiment-latest")
roberta_results = roberta_pipeline(tokenizer.decode(tokens['input_ids'][0]))
print(roberta_results)
#[{'label': 'neutral', 'score': 0.93180251121521}]



f_bert_pipeline = pipeline("sentiment-analysis", model = "ahmedrachid/FinancialBERT-Sentiment-Analysis", truncation = True)
f_bert_results = f_bert_pipeline(cleaned_text)
print(f_bert_results)
#[{'label': 'neutral', 'score': 0.9886075854301453}] and appraisal is C3